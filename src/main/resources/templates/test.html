<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로또 6/45 - 행운의 번호 생성</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/header.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --danger-color: #F44336;
            --text-color: #333333;
            --background-color: #f5f5f5;
            --card-background: #ffffff;
        }

        /* 메인 컨테이너 */
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* 카드 스타일 */
        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card h2 i {
            margin-right: 10px;
        }

        /* 번호 스타일 */
        .numbers-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .number {
            width: 50px;
            height: 50px;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
        }

        .number-operator {
            width: 50px;
            height: 50px;
            color: black;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* 버튼 스타일 */
        .main-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: block;
            margin: 20px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .main-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }

        /* 사용자 기록 스타일 */
        .user-record {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        .user-record:last-child {
            border-bottom: none;
        }

        .user-record p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .user-numbers {
            display: flex;
            gap: 5px;
        }

        .user-number {
            width: 30px;
            height: 30px;
            font-size: 14px;
        }

        /* 색상 클래스 */
        .yellow { background-color: #FFC107; }
        .blue { background-color: #2196F3; }
        .red { background-color: #F44336; }
        .gray { background-color: #9E9E9E; }

        /* 당첨 결과 테이블 */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .result-table th, .result-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .result-table th {
            background-color: var(--secondary-color);
            color: white;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
            }

            nav ul {
                margin-top: 15px;
                justify-content: center;
            }

            nav ul li {
                margin: 0 10px;
            }
        }
    </style>
</head>
<body>

<header th:replace="~{header.html}"></header>

<div class="container">
    <div class="cards-container">
        <div class="card">
            <h2><i class="fas fa-random"></i> 로또번호 생성</h2>
            <button class="main-button" onclick="generateNumbers()">번호 생성하기</button>
            <div class="numbers-container" id="generated-numbers">
                <!-- 번호는 JavaScript로 생성됨 -->
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-trophy"></i> 최근 당첨번호</h2>
            <p id="drawNum"><strong>${drawNum}회 당첨결과</strong> (2024.03.16 추첨)</p>
            <div class="numbers-container">
                <div class="number red" id="winningNum1"></div>
                <div class="number red" id="winningNum2"></div>
                <div class="number red" id="winningNum3"></div>
                <div class="number red" id="winningNum4"></div>
                <div class="number red" id="winningNum5"></div>
                <div class="number red" id="winningNum6"></div>
                <div class="number-operator">+</div>
                <div class="number yellow" id="bonusNum"></div>
            </div>
            <p id="firstPrizeAmount">1등 당첨금: ${firstPrizeAmount}</p>
        </div>

        <div class="card">
            <h2><i class="fas fa-users"></i> 사용자 당첨 기록</h2>
            <div class="user-record">
                <p><strong>1139회 5등</strong> by st5454 (2024.09.26 18:40:16)</p>
                <div class="user-numbers">
                    <div class="number user-number yellow">3</div>
                    <div class="number user-number yellow">4</div>
                    <div class="number user-number yellow">5</div>
                    <div class="number user-number blue">12</div>
                    <div class="number user-number red">30</div>
                    <div class="number user-number gray">39</div>
                </div>
            </div>
            <div class="user-record">
                <p><strong>1139회 5등</strong> by monandol (2024.09.22 00:35:47)</p>
                <div class="user-numbers">
                    <div class="number user-number yellow">2</div>
                    <div class="number user-number yellow">10</div>
                    <div class="number user-number blue">12</div>
                    <div class="number user-number red">24</div>
                    <div class="number user-number red">30</div>
                    <div class="number user-number gray">37</div>
                </div>
            </div>
            <div class="user-record">
                <p><strong>1139회 3등</strong> by guest (2024.09.24 04:21:48)</p>
                <div class="user-numbers">
                    <div class="number user-number yellow">5</div>
                    <div class="number user-number blue">12</div>
                    <div class="number user-number blue">15</div>
                    <div class="number user-number red">25</div>
                    <div class="number user-number gray">37</div>
                    <div class="number user-number gray">40</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-chart-bar"></i> 당첨 통계</h2>
            <p>사용자들의 이번 회차 당첨 결과</p>
            <table class="result-table">
                <tr>
                    <th>등수</th>
                    <th>당첨자 수</th>
                    <th>당첨금</th>
                </tr>
                <tr>
                    <td>1등</td>
                    <td>12명</td>
                    <td>23억 5천만원</td>
                </tr>
                <tr>
                    <td>2등</td>
                    <td>56명</td>
                    <td>5천만원</td>
                </tr>
                <tr>
                    <td>3등</td>
                    <td>2,346명</td>
                    <td>150만원</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>

    $(function (){
        getLatestLottery();
    })

    // 번호 생성 메서드
    function generateNumbers() {
        // id가 generated-numbers인 태그를 가지고 온다.
        // 추후 부모 div가 될 거임
        const numbersContainer = document.getElementById('generated-numbers');
        // 번호 재 생성 시 원래 값을 지워주기 위함
        numbersContainer.innerHTML = '';

        // 번호 중복 안되도록 Set 사용하고 랜덤 숫자 넣어줌
        const numbers = new Set();
        while(numbers.size < 6) {
            numbers.add(Math.floor(Math.random() * 45) + 1);
        }

        // 정렬
        const sortedNumbers = Array.from(numbers).sort((a, b) => a - b);
        // 서버로 보낼 데이터(객체) 생성 (lottoNum1 이런식으로 key 값 보내주기 위해서 만듦. 여기서 키값은 서버에서 필드 값임)
        const lottoNums = {}

        sortedNumbers.forEach((number, index) => {
            setTimeout(() => {
                // div 태그 생성
                const div = document.createElement('div');
                // div의 class 이름을 number로 설정
                div.className = 'number';
                // div의 text 값에 number 설정
                div.textContent = number;
                // 서버에 보낼 데이터 가공 ex) lottoNum1 : 12
                lottoNums[`lottoNum${index + 1}`] = number;
                // 숫자에 따른 색상 설정
                div.classList.add(getColorClass(number));

                // numbersContainer(generated-numbers가 id인 태그)라는 변수에 자식 태그 설정
                numbersContainer.appendChild(div);

                // 비동기 방식이기 때문에 sendNumbersToServer 메서드를 밖으로 뺴면
                // 모든 숫자가 forEach 돌기 전에 sendNumbersToServer 실행이 되므로
                // 현재 인덱스를 확인 후 마지막 순번일 때 sendNumbersToServer 메서드를 실행하게 함

                // (인덱스가 마지막인 경우)마지막 숫자를 추가한 후 서버로 전송
                if (index === sortedNumbers.length - 1) {
                    sendNumbersToServer(lottoNums);
                }
            }, index * 200);
        });
    }

    // 생성된 번호 DB 저장 메서드
    function sendNumbersToServer(lottoNums) {
        console.log("number : ", lottoNums);
        fetch('/user-lotto/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(lottoNums)
        })
    }

    // 번호 색상 입히는 메서드
    function getColorClass(number) {
        if (number <= 10) return 'yellow';
        if (number <= 20) return 'blue';
        if (number <= 30) return 'red';
        return 'gray';
    }

    // 최근 당첨 번호 가져오는 메서드
    function getLatestLottery() {

        $.ajax({
            url: '/lotto/get/latest-lottery',
            method: 'GET',
            contentType: 'application/json',
            success: function(data) {
                // 받아온 데이터로 HTML 요소 업데이트
                $("#drawNum").html(`<strong>${data.drawNum}회 당첨결과</strong> (${data.crtDt} 추첨)`);
                $("#winningNum1").text(data.winningNum1);
                $("#winningNum2").text(data.winningNum2);
                $("#winningNum3").text(data.winningNum3);
                $("#winningNum4").text(data.winningNum4);
                $("#winningNum5").text(data.winningNum5);
                $("#winningNum6").text(data.winningNum6);
                $("#bonusNum").text(data.bonusNum);
                $("#firstPrizeAmount").text(`1등 당첨금: ${data.firstPrizeAmount}`);
            },
            error: function(error) {
                console.error("오류 발생:", error);
            }
        });
    }
</script>
</body>
</html>